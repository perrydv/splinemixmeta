# Introduction

Package `splinemixmeta` provides some basic capabilities in non-parametric meta-regression. If one has responses `y`, each with a standard error, from previous analyses, and wants to regress those against study-level explanatory variables `x` without assuming linearity, `splinemixmeta` allows an arbitrary smooth relationship to be estimated as a smoothing spline. It is also possible to include other explanatory variables (assumed to have a linear relationship to `y`) and random effects groupings. Such an approach may be referred to as "non-parametric meta-analysis", "spline meta-regression", "meta-splines", or other similar terminology mashups.

`splinemixmeta` works by bringing together features of `mgcv` for building spline components and `mixmeta` for estimating general mixed-effects meta-analysis models. Specifically, the splines of `mgcv` can be used as random effects components, with the penalty matrix providing a correlation structure for spline coefficients, the unknown smoothness parameter replaced by an unknown variance parameter, and any unpenalized directions in the spline parameter space (e.g. spline parameters representing a linear relationship) moved into fixed effects. The resulting pieces are then set up as needed for a call to `mixmeta::mixmeta` for estimating the model. Variance parameters are always estimated by REML (restricted maximum likelihood).

There are some important limits on what will work. At the moment, only spline choices for which covariance matrices can be diagonalized are supported. One can have multiple such components. In practice, the only bivariate spline (i.e. not simply addition of two univariate splines) that can work is `bs = 'tp'`. In it possible that `bs = 'mrf'` also works, but it has not been tested. See `help(splinemixmeta)` for more about what is supported.

The estimation machinery is not particularly efficient and so will be notably slow for large models.

# Example

Here we give a simulated example. Say we have `n=50` values, with 5 values from each of 10 groups, with a sinusoidal relationship between `y` and `x` to provide a simple nonlinear example. The groups will be treated as random effects, as will the spline.

## Data simulation

```{r}
n <- 50
num_groups <- 10
group <- rep(1:num_groups, each = 5) |> factor()
group_effects <- rnorm(length(group), 0, 0.3)
x <- runif(n, 0, 20)
coef_x <- 0.6
se <- runif(n, 0.1, 0.3)
fx <- sin(2 * pi * x / 12)
y <- 10 + coef_x * x + fx + group_effects[group] + fx + rnorm(n, 0, 1) + rnorm(n, 0, se)
data <- data.frame(y, x, se)
```

This data simulation has the following steps:

- We have 10 groups of 5 data points each. Since the `x` values are drawn independently, the groups are randomly associated with `x` values.
- `x` is uniformly distribution from 0 to 20.
- Fixed effects for `y` include an intercept, linear term, and sinusoidal term.
- Random effects for `y` include the group effects.
- The sinusoidal term for `y` will be estimated as a spline, treated as a random effect.
- Residuals are normally distributed with `sd = 1`.
- Measurement errors (i.e. estimation error from the previous studies from which `y` were obtained`) are normally distribution with standard deviations that are the standard errors from the previous studies. These are simulated as uniformly distributed between 0.1 and 0.3.

## Estimation of a spline meta-regression model

```{r}
smm <- splinemixmeta( mgcv::s(x), y ~ x, manual_fixed = TRUE, data, random = ~ 1 | group)
```
